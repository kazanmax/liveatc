<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Airport Ambient</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#222425; --fg:#ddd; --muted:#9aa0a3;
      --track:#2a2d2e; --track-edge:#121314; --glow:rgba(255,255,255,.08);
      --focus:rgba(120,200,255,.35); --thumb:#0e1112;
      --accent-ambient:#ffb84d; --accent-ambient-glow:rgba(255,184,77,.45);
      --accent-atc:#3ee58e; --accent-atc-glow:rgba(62,229,142,.40);
      --accent-master:#7dd3fc; --accent-master-glow:rgba(125,211,252,.40);
      --card:rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,0.06), transparent 55%), var(--bg);
      color:var(--fg);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:18px; padding:24px;
    }
    h1{margin:0 0 6px; font-weight:600; letter-spacing:.3px}

    .wrap{display:grid; gap:16px; width:min(920px, 96vw)}
    .card{
      padding:14px 16px; border-radius:14px;
      background:var(--card);
      box-shadow:0 2px 0 rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .grid-2{display:grid; grid-template-columns:1fr auto; gap:14px; align-items:center}
    .sub{color:var(--muted); font-size:13px}

    /* ---------- Buttons ---------- */
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:8px 12px; border-radius:10px; font:inherit; color:#e8eef1;
      background:rgba(255,255,255,.05);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn[aria-pressed="true"]{ background:rgba(255,80,80,.18); box-shadow:0 0 0 2px rgba(255,80,80,.25) inset; }
    .btn--small{ padding:6px 10px; font-size:14px }

    /* ---------- Sliders ---------- */
    .slider{
      --accent:#00d07a; --accent-glow:rgba(0,208,122,.35);
      width:320px; max-width:80vw;
      appearance:none; height:42px; background:transparent; position:relative; cursor:pointer;
    }
    .slider:focus-visible{ outline:none; }
    .slider::before{
      content:""; position:absolute; left:0; right:0; top:50%; height:6px; transform:translateY(-50%);
      border-radius:999px;
      background:
        linear-gradient(to right, var(--accent) var(--fill,0%), var(--track) var(--fill,0%)),
        repeating-linear-gradient(to right, transparent 0 28px, rgba(255,255,255,.12) 28px 29px, transparent 29px 58px),
        linear-gradient(var(--track-edge), var(--track-edge));
      background-size:100% 6px, 100% 6px, 100% 1px;
      background-position:0 0, 0 0, 0 100%;
      background-repeat:no-repeat;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), inset 0 1px 0 var(--glow);
    }
    .slider::-webkit-slider-thumb{
      appearance:none; width:18px; height:18px; margin-top:12px;
      border-radius:50%;
      background:
        radial-gradient(6px 6px at 50% 50%, white 0 2px, transparent 2px),
        linear-gradient(var(--thumb), var(--thumb));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 0 0 3px rgba(0,0,0,.35), 0 0 18px -2px var(--accent-glow);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .slider:hover::-webkit-slider-thumb{ transform:scale(1.02) }
    .slider:active::-webkit-slider-thumb{ transform:scale(0.98) }
    .slider:focus-visible::-webkit-slider-thumb{
      box-shadow:0 0 0 4px var(--focus), 0 0 18px -2px var(--accent-glow);
    }
    .slider::-moz-range-track{ background:transparent; height:42px; }
    .slider::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background:
        radial-gradient(6px 6px at 50% 50%, white 0 2px, transparent 2px),
        linear-gradient(var(--thumb), var(--thumb));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 0 0 3px rgba(0,0,0,.35), 0 0 18px -2px var(--accent-glow);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .slider:hover::-moz-range-thumb{ transform:scale(1.02) }
    .slider:active::-moz-range-thumb{ transform:scale(0.98) }
    .slider:focus-visible::-moz-range-thumb{ box-shadow:0 0 0 4px var(--focus), 0 0 18px -2px var(--accent-glow); }
    .slider--ambient{ --accent:var(--accent-ambient); --accent-glow:var(--accent-ambient-glow); }
    .slider--atc{ --accent:var(--accent-atc); --accent-glow:var(--accent-atc-glow); }
    .slider--master{ --accent:var(--accent-master); --accent-glow:var(--accent-master-glow); }

    /* ---------- Analog VU (только для ATC) ---------- */
    .vu{
      --ring:#0f1011;
      --tick:#4e565b;
      --tick-major:#b9c2c6;
      --label:#c9d1d5;
      --needle:#e6edf3;
      width:190px; height:120px; position:relative; user-select:none;
      border-radius:14px; padding:10px;
      background:var(--card);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    .vu__dial{
      position:relative; width:100%; height:100%;
      border-radius:12px;
      background:
        radial-gradient(160px 70px at 50% 100%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(#0c0d0e, #0c0d0e);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04), inset 0 -6px 24px rgba(0,0,0,.5);
    }
    .vu__arc{ position:absolute; left:12px; right:12px; bottom:18px; height:86px; }
    .vu__tick{
      position:absolute; left:50%; bottom:14px; width:2px; height:10px;
      background:var(--tick); transform-origin:50% 76px; opacity:.9;
    }
    .vu__tick--major{ height:14px; width:2.6px; background:var(--tick-major); }
    .vu__label{
      position:absolute; left:50%; bottom:26px; transform:translateX(-50%); font-size:12px; color:var(--label);
      letter-spacing:.06em;
    }
    .vu__needle{
      position:absolute; left:50%; bottom:22px; width:2px; height:80px;
      background:linear-gradient(var(--needle), var(--needle));
      transform-origin:50% 78px; transform:rotate(-48deg);
      box-shadow:0 0 12px rgba(255,255,255,.14);
    }
    .vu__cap{
      position:absolute; left:50%; bottom:22px; width:14px; height:14px; transform:translate(-50%,0);
      border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #fff 0 2px, #222 8px, #111 10px, transparent 11px);
      box-shadow:0 0 0 1px rgba(255,255,255,.1), inset 0 1px 0 rgba(255,255,255,.1);
    }

    /* Layout helpers */
    .atc-header{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between }
    .atc-controls{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .atc-footer{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:10px }

    /* mobile vertical sliders */
    @media (max-width:560px){
      .stack-vertical{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px }
      .stack-vertical .slider{
        width:36vh; max-width:unset; transform:rotate(-90deg);
      }
      .stack-vertical .label{ order:-1 }
    }
  </style>

  <!-- SoundCloud API -->
  <script src="https://w.soundcloud.com/player/api.js" defer></script>
</head>
<body>
  <h1>Airport Ambient Radio</h1>
  <div class="wrap">

    <!-- MASTER -->
    <div class="card">
      <div class="row">
        <strong class="label">Master volume</strong>
        <input type="range" class="slider slider--master" id="masterVolume" min="0" max="1" step="0.01" value="0.6" />
        <button class="btn btn--small" id="masterMute" aria-pressed="false" title="Mute all">Mute</button>
        <button class="btn btn--small" id="pauseAll" aria-pressed="false" title="Pause/Resume all">Pause all</button>
      </div>
      <div class="sub">Управляет обоими источниками; изменения с мягким fade.</div>
    </div>

    <!-- Ambient / SoundCloud -->
    <div class="card">
      <iframe
        id="sc-player"
        width="100%"
        height="300"
        scrolling="no"
        allow="autoplay"
        src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/soundcloud%253Aplaylists%253A1573126828&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true">
      </iframe>

      <div class="row stack-vertical" style="margin-top:8px">
        <span class="label">Ambient volume</span>
        <input type="range" class="slider slider--ambient" id="scVolume" min="0" max="1" step="0.01" value="0.5">
        <button class="btn btn--small" id="scMute" aria-pressed="false">Mute</button>
      </div>
    </div>

    <!-- LiveATC + VU -->
    <div class="card">
      <div class="atc-header">
        <audio id="atc" controls autoplay loop crossorigin="anonymous" style="flex:1 1 auto; min-width:220px">
          <source src="https://s1-fmt2.liveatc.net/unnt" type="audio/mpeg" />
          Ваш браузер не поддерживает аудио.
        </audio>

        <!-- ATC VU Gauge -->
        <div class="vu" id="atcVu" aria-hidden="true">
          <div class="vu__dial">
            <div class="vu__arc" id="vuTicks"></div>
            <div class="vu__needle" id="vuNeedle"></div>
            <div class="vu__cap"></div>
            <div class="vu__label">ATC VU</div>
          </div>
        </div>
      </div>

      <div class="atc-footer">
        <div class="atc-controls stack-vertical">
          <span class="label">LiveATC volume</span>
          <input type="range" class="slider slider--atc" id="atcVolume" min="0" max="1" step="0.01" value="0.5">
          <button class="btn btn--small" id="atcMute" aria-pressed="false">Mute</button>
        </div>
        <div class="sub" style="text-align:right">Если автоплей где-то блокируется — шевельните ползунок или нажмите Play.</div>
      </div>
    </div>

  </div>

  <script>
    // ---------- small utils ----------
    const clamp01 = v => Math.min(1, Math.max(0, v));
    const toPct = v => `${Math.round(clamp01(v) * 100)}%`;
    const paintFill = (slider) => slider.style.setProperty('--fill', toPct(parseFloat(slider.value || '0')));
    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    // Smooth volume ramp (source setter is a function receiving 0..1)
    async function fadeTo(setter, getCurrent, target, { duration = 250, steps = 12 } = {}){
      const from = clamp01(getCurrent());
      const to = clamp01(target);
      if (Math.abs(from - to) < 0.001){ setter(to); return; }
      const dt = duration / steps;
      for (let i = 1; i <= steps; i++){
        const t = i/steps;
        const v = from + (to - from) * t;
        setter(v);
        // eslint-disable-next-line no-await-in-loop
        await wait(dt);
      }
      setter(to);
    }

    // ------- DOM ready -------
    window.addEventListener('DOMContentLoaded', () => {
      // Elements
      const atcAudio  = document.getElementById('atc');
      const atcSlider = document.getElementById('atcVolume');
      const scSlider  = document.getElementById('scVolume');
      const master    = document.getElementById('masterVolume');
      const btnAtcMute = document.getElementById('atcMute');
      const btnScMute  = document.getElementById('scMute');
      const btnMasterMute = document.getElementById('masterMute');
      const btnPauseAll = document.getElementById('pauseAll');

      // initial paints
      [master, atcSlider, scSlider].forEach(paintFill);

      // cached volumes for mute toggles
      let atcSaved = parseFloat(atcSlider.value || '0.5');
      let scSaved  = parseFloat(scSlider.value || '0.5');
      let masterSaved = parseFloat(master.value || '0.6');

      // ---- ATC: local audio ----
      atcAudio.volume = clamp01(atcSaved);
      atcSlider.addEventListener('input', (e) => {
        const v = clamp01(parseFloat(e.target.value));
        paintFill(atcSlider);
        atcSaved = v;
        fadeTo(x => atcAudio.volume = x, () => atcAudio.volume, v);
        paintFill(master);
      });

      // ---- SoundCloud via Widget API ----
      const scIframe = document.getElementById('sc-player');
      let scWidget = null;
      let scCurrent = clamp01(scSaved);

      function setScVol01(v01){
        scCurrent = clamp01(v01);
        if (scWidget) scWidget.setVolume(Math.round(scCurrent * 100));
      }

      const initSC = () => {
        if (!window.SC || !SC.Widget) return setTimeout(initSC, 50);
        scWidget = SC.Widget(scIframe);
        scWidget.bind(SC.Widget.Events.READY, () => {
          setScVol01(scCurrent);
          scSlider.addEventListener('input', (e) => {
            const v = clamp01(parseFloat(e.target.value));
            paintFill(scSlider);
            scSaved = v;
            fadeTo(setScVol01, () => scCurrent, v);
            paintFill(master);
          });
        });
      };
      initSC();

      // ---- MASTER ----
      function getAtc(){ return clamp01(atcAudio.volume); }
      function getSc(){ return clamp01(scCurrent); }
      function setAtc(v){ atcAudio.volume = clamp01(v); }
      function setSc(v){ setScVol01(v); }

      master.addEventListener('input', async (e) => {
        const m = clamp01(parseFloat(e.target.value));
        paintFill(master);
        masterSaved = m;
        const atcTarget = clamp01(atcSlider.value * m);
        const scTarget  = clamp01(scSlider.value * m);
        fadeTo(setAtc, getAtc, atcTarget);
        fadeTo(setSc,  getSc,  scTarget);
      });

      // ---- MUTES ----
      btnAtcMute.addEventListener('click', () => {
        const pressed = btnAtcMute.getAttribute('aria-pressed') === 'true';
        if (pressed){
          btnAtcMute.setAttribute('aria-pressed','false');
          fadeTo(setAtc, getAtc, atcSaved * masterSaved);
        } else {
          btnAtcMute.setAttribute('aria-pressed','true');
          fadeTo(setAtc, getAtc, 0);
        }
      });

      btnScMute.addEventListener('click', () => {
        const pressed = btnScMute.getAttribute('aria-pressed') === 'true';
        if (pressed){
          btnScMute.setAttribute('aria-pressed','false');
          fadeTo(setSc, getSc, scSaved * masterSaved);
        } else {
          btnScMute.setAttribute('aria-pressed','true');
          fadeTo(setSc, getSc, 0);
        }
      });

      btnMasterMute.addEventListener('click', () => {
        const pressed = btnMasterMute.getAttribute('aria-pressed') === 'true';
        if (pressed){
          btnMasterMute.setAttribute('aria-pressed','false');
          fadeTo(setAtc, getAtc, atcSaved * masterSaved);
          fadeTo(setSc,  getSc,  scSaved  * masterSaved);
        } else {
          btnMasterMute.setAttribute('aria-pressed','true');
          fadeTo(setAtc, getAtc, 0);
          fadeTo(setSc,  getSc,  0);
        }
      });

      // ---- Pause all ----
      btnPauseAll.addEventListener('click', () => {
        const pressed = btnPauseAll.getAttribute('aria-pressed') === 'true';
        if (pressed){
          btnPauseAll.setAttribute('aria-pressed','false');
          atcAudio.play().catch(()=>{});
          if (scWidget && scWidget.play) scWidget.play();
        } else {
          btnPauseAll.setAttribute('aria-pressed','true');
          atcAudio.pause();
          if (scWidget && scWidget.pause) scWidget.pause();
        }
      });

      // -------- ATC VU Meter (реальный через Web Audio, с мягким fallback) --------
      const vu = document.getElementById('atcVu');
      const ticksHost = document.getElementById('vuTicks');
      const needle = document.getElementById('vuNeedle');

      // разметка делений (-48° .. +18°, 12 основных + мелкие)
      (function buildTicks(){
        const start = -48, end = 18; // градусы
        const majors = 12;
        const minorsPer = 3;
        for(let m=0;m<=majors;m++){
          const ang = start + (end-start)*(m/majors);
          const t = document.createElement('div');
          t.className = 'vu__tick vu__tick--major';
          t.style.transform = `rotate(${ang}deg)`;
          ticksHost.appendChild(t);

          if (m<majors){
            for(let s=1;s<=minorsPer;s++){
              const frac = (m + s/(minorsPer+1))/majors;
              const angS = start + (end-start)*frac;
              const sm = document.createElement('div');
              sm.className = 'vu__tick';
              sm.style.transform = `rotate(${angS}deg)`;
              ticksHost.appendChild(sm);
            }
          }
        }
      })();

      // преобразование RMS (0..~0.5) -> угол
      const ANG_MIN = -48, ANG_MAX = 18; // градусы
      const meterEase = 0.12; // сглаживание стрелки

      let targetLevel = 0; // 0..1
      let shownLevel = 0;  // 0..1 (сглаженный)
      function levelToAngle(l){ return ANG_MIN + (ANG_MAX-ANG_MIN) * clamp01(l); }
      function renderNeedle(){
        // экспоненциальное сглаживание
        shownLevel += (targetLevel - shownLevel) * meterEase;
        needle.style.transform = `rotate(${levelToAngle(shownLevel)}deg)`;
        requestAnimationFrame(renderNeedle);
      }
      requestAnimationFrame(renderNeedle);

      // Попытка реального анализа через Web Audio
      let analyser = null, data = null, audioCtx = null, sourceNode = null, rafId = null;
      let realVU = false;

      function computeRMSFloat(arr){
        let sum = 0;
        for (let i=0;i<arr.length;i++){ const v = arr[i]; sum += v*v; }
        return Math.sqrt(sum / arr.length);
      }

      function pumpVU(){
        if (!analyser) return;
        const buf = data;
        analyser.getFloatTimeDomainData(buf);
        const rms = computeRMSFloat(buf); // ~0..1
        // нормируем под человеческую шкалу и чуть прижимаем хвост
        const norm = clamp01((rms * 3.2)); // поджать чувствительность под голос/шум
        targetLevel = norm;
        rafId = requestAnimationFrame(pumpVU);
      }

      async function initRealVU(){
        try{
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          sourceNode = audioCtx.createMediaElementSource(atcAudio);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;
          data = new Float32Array(analyser.fftSize);
          // вешаем анализатор параллельно воспроизведению
          sourceNode.connect(analyser);
          sourceNode.connect(audioCtx.destination);
          realVU = true;
          pumpVU();
        } catch(e){
          console.warn('ATC VU: реальный анализ недоступен, включаем fallback', e);
          realVU = false;
        }
      }

      // Fallback-помощник: если не удалось реальное аудио, модулируем по громкости
      function startPseudoVU(){
        let t = 0;
        (function loop(){
          if (realVU) return; // если позже включится реальный — прекращаем псевдо
          t += 0.016;
          // базовый уровень от громкости канала с учётом master
          const base = clamp01(atcSlider.value * master.value);
          // лёгкая "дрожь" (шумовая модуляция)
          const wobble = (Math.sin(t*6.3)+Math.sin(t*3.7+1.2))*0.04;
          targetLevel = clamp01(base * 0.9 + 0.1 + wobble);
          requestAnimationFrame(loop);
        })();
      }

      // Стартуем VU: пытаемся Real → иначе Pseudo
      initRealVU().finally(() => {
        if (!realVU) startPseudoVU();
      });

      // Если пользователь запускает/ставит на паузу аудио, поднимаем/возобновляем контекст
      atcAudio.addEventListener('play', () => {
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      });

      // repaint fills на первый тик
      requestAnimationFrame(() => {
        [master, atcSlider, scSlider].forEach(paintFill);
      });
    });
  </script>
</body>
</html>
